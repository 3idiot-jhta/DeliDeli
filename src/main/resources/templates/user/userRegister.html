<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>사용자 등록</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <style>
        .error-message {
            color: red;
        }
        .success-message {
            color: green;
        }
    </style>
</head>
<body>
<h1>사용자 등록</h1>
<form id="registerForm" action="/user/register" method="post" enctype="multipart/form-data">
    <label for="userId">사용자 ID:</label>
    <input type="text" id="userId" name="userId" required>
    <button type="button" id="checkUserIdButton">아이디 중복 확인</button>
    <span id="userIdMessage" class="error-message"></span>
    <br>
    <label for="userPw">비밀번호:</label>
    <input type="password" id="userPw" name="userPw" required>
    <br>
    <label for="checkUserPw">비밀번호 확인:</label>
    <input type="password" id="checkUserPw" name="checkUserPw" required>
    <span id="passwordMessage" class="error-message"></span>
    <br>
    <label for="userName">이름:</label>
    <input type="text" id="userName" name="userName" required>
    <br>
    <label for="userNickname">닉네임:</label>
    <input type="text" id="userNickname" name="userNickname" required>
    <br>
    <label for="userBirth">생년월일:</label>
    <input type="text" id="userBirth" name="userBirth" required>
    <br>
    <label for="userPhone">전화번호:</label>
    <input type="text" id="userPhone" name="userPhone" required>
    <br>
    <label for="userEmail">이메일:</label>
    <input type="email" id="userEmail" name="userEmail" required>
    <span id="userEmailMessage" class="error-message"></span>
    <button type="button" id="sendCodeButton">인증 코드 전송</button>
    <br>
    <label for="verificationCode">인증 코드:</label>
    <input type="text" id="verificationCode" name="verificationCode" required>
    <button type="button" id="verifyCodeButton">인증 코드 확인</button>
    <br>
    <label for="userProfile">프로필 이미지:</label>
    <input type="file" id="userProfile" name="userProfile">
    <br>
    <!-- 주소 입력 필드 추가 -->
    <label for="userAddress">주소:</label>
    <input type="text" id="userAddress" name="userAddress" required readonly>
    <button type="button" onclick="execDaumPostcode()">주소 찾기</button>
    <br>
    <label for="userZipcode">우편번호:</label>
    <input type="text" id="userZipcode" name="userZipcode" required readonly>
    <br>
    <label for="userAddrDetail">상세 주소:</label>
    <input type="text" id="userAddrDetail" name="userAddrDetail" required>
    <br>
    <button type="submit" id="registerButton" disabled>등록</button>
    <li><a href="/">뒤로가기</a></li>
</form>
<div id="message" class="success-message"></div>
<div id="errorMessage" class="error-message"></div>

<script>
    function execDaumPostcode() {
        new daum.Postcode({
            oncomplete: function(data) {
                var addr = ''; // 주소 변수
                var extraAddr = ''; // 참고항목 변수

                if (data.userSelectedType === 'R') { // 사용자가 도로명 주소를 선택했을 경우
                    addr = data.roadAddress;
                } else { // 사용자가 지번 주소를 선택했을 경우
                    addr = data.jibunAddress;
                }

                if(data.userSelectedType === 'R'){
                    if(data.bname !== '' && /[동|로|가]$/g.test(data.bname)){
                        extraAddr += data.bname;
                    }
                    if(data.buildingName !== '' && data.apartment === 'Y'){
                        extraAddr += (extraAddr !== '' ? ', ' + data.buildingName : data.buildingName);
                    }
                    if(extraAddr !== ''){
                        extraAddr = ' (' + extraAddr + ')';
                    }
                }

                document.getElementById('userZipcode').value = data.zonecode;
                document.getElementById("userAddress").value = addr + extraAddr;
                document.getElementById("userAddrDetail").focus();
            }
        }).open();
    }

    $(document).ready(function() {
        $("#sendCodeButton").click(function() {
            var email = $("#userEmail").val();
            $.post("/user/sendVerificationCode", { email: email }, function(data) {
                $("#message").text("인증 코드가 전송되었습니다.");
            }).fail(function() {
                $("#errorMessage").text("인증 코드 전송에 실패했습니다.");
            });
        });

        $("#verifyCodeButton").click(function() {
            var email = $("#userEmail").val();
            var code = $("#verificationCode").val();
            $.post("/user/verifyCode", { email: email, code: code }, function(data) {
                if (data.valid) {
                    $("#message").text("이메일 인증이 완료되었습니다.");
                    $("#registerButton").prop("disabled", false);
                } else {
                    $("#errorMessage").text("인증 코드가 일치하지 않습니다.");
                }
            }).fail(function() {
                $("#errorMessage").text("인증 코드 확인에 실패했습니다.");
            });
        });

        $("#checkUserIdButton").click(function() {
            var userId = $("#userId").val();
            $("#userIdMessage").text("");  // Clear previous message
            $.post("/user/checkUserId", { userId: userId }, function(data) {
                if (data) {
                    $("#userIdMessage").text("사용할 수 없는 아이디입니다.").removeClass('success-message').addClass('error-message');
                } else {
                    $("#userIdMessage").text("사용할 수 있는 아이디입니다.").removeClass('error-message').addClass('success-message');
                }
            }).fail(function() {
                $("#userIdMessage").text("아이디 확인에 실패했습니다.");
            });
        });

        $("#checkUserPw").keyup(function() {
            var password = $("#userPw").val();
            var checkPassword = $("#checkUserPw").val();
            if (password !== checkPassword) {
                $("#passwordMessage").text("비밀번호가 일치하지 않습니다.").removeClass('success-message').addClass('error-message');
            } else {
                $("#passwordMessage").text("비밀번호가 일치합니다.").removeClass('error-message').addClass('success-message');
            }
        });

        $("#userEmail").keyup(function () {
            var email = $("#userEmail").val();
            $("#userEmailMessage").text("");
            // 이메일 중복 확인
            $.ajax({
                url: "/user/checkUserEmail",
                type: "POST",
                data: {email: email},
                async: false,
                success: function (data) {
                    if (data) {
                        $("#userEmailMessage").text("사용할 수 없는 이메일입니다.").removeClass('success-message').addClass('error-message');
                        isValid = false;
                    } else {
                        $("#userEmailMessage").text("사용할 수 있는 이메일입니다.").removeClass('error-message').addClass('success-message');
                    }
                },
                error: function () {
                    $("#errorMessage").text("이메일 확인에 실패했습니다.");
                    isValid = false;
                }
            });
        });

        $("#registerForm").submit(function(event) {
            event.preventDefault(); // 폼 기본 제출 방지

            var email = $("#userEmail").val();
            var isValid = true;

            $("#userEmailMessage").text("");
            $("#errorMessage").text("");
            $("#message").text("");

            // 폼 제출
            if (isValid) {
                $("#registerForm")[0].submit();
            }
        });
    });
</script>
</body>
</html>
