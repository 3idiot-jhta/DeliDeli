<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" >
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
        .reply-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            background-color: #ffe0e6; /* 배경 색상 설정 */
        }
        .reply-item.reply-child {
            margin-left: 20px; /* 자식 대댓글 들여쓰기 */
        }
        .reply-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .reply-header img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
        }
        .reply-header .username {
            font-weight: bold;
            margin-right: 10px;
        }
        .reply-header .date {
            color: #888;
        }
        .reply-content {
            margin-bottom: 10px;
        }
        .reply-actions {
            text-align: right;
        }
        .reply-actions button {
            background-color: #337ab7;
            color: white;
            border: none;
            padding: 5px 10px;
            margin: 0 2px;
            border-radius: 4px;
            cursor: pointer;
        }
        .reply-actions button:hover {
            background-color: #286090;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        var contextPath = ""; // 실제 contextPath로 변경하세요
        var boardKey = 12; // 실제 boardKey로 변경하세요

        function selectReplyList(boardKey) {
            console.log("댓글목록조회실행");
            $.ajax({
                url: contextPath + "/user/eventDetail?boardKey=" + boardKey,
                type: "GET",
                dataType: "JSON", // JSON 형태의 문자열 응답 데이터를 JS 객체로 자동 변환
                success: function(rList) {
                    console.log("성공시")
                    console.log("url"+ url);
                    // rList : 반환 받은 댓글 목록
                    console.log("댓글목록" + rList);
                    displayReplies(rList);
                }

            });
        }

        function displayReplies(replies) {
            var replyList = document.getElementById("replyList");
            replyList.innerHTML = ""; // 기존 댓글 목록을 지움
            var replyMap = {}; // 댓글을 부모 키로 매핑하기 위한 객체

            // 모든 댓글을 먼저 replyMap에 저장
            replies.forEach(function(reply) {
                replyMap[reply.comment_key] = reply;
                replyMap[reply.comment_key].children = [];
            });

            // 각 댓글을 부모 댓글의 자식 배열에 추가
            replies.forEach(function(reply) {
                if (reply.comment_parent) {
                    replyMap[reply.comment_parent].children.push(reply);
                }
            });

            // 최상위 부모 댓글만 화면에 표시
            replies.forEach(function(reply) {
                if (!reply.comment_parent) {
                    appendReply(reply, replyList);
                }
            });
        }

        function appendReply(reply, parentElement) {
            var replyItem = document.createElement("div");
            replyItem.className = "reply-item" + (reply.comment_parent ? " reply-child" : "");

            var replyHeader = document.createElement("div");
            replyHeader.className = "reply-header";

            var userAvatar = document.createElement("img");
            userAvatar.src = "https://via.placeholder.com/40"; // 기본 아바타 이미지

            var username = document.createElement("span");
            username.className = "username";
            username.textContent = reply.userNickname; // 사용자 이름

            var date = document.createElement("span");
            date.className = "date";
            date.textContent = new Date(reply.comment_regdate).toLocaleString(); // 작성 시간

            replyHeader.appendChild(userAvatar);
            replyHeader.appendChild(username);
            replyHeader.appendChild(date);

            var replyContent = document.createElement("div");
            replyContent.className = "reply-content";
            replyContent.textContent = reply.comment_contents; // 댓글 내용

            var replyActions = document.createElement("div");
            replyActions.className = "reply-actions";

            var replyButton = document.createElement("button");
            replyButton.textContent = "답글";

            var editButton = document.createElement("button");
            editButton.textContent = "수정";

            var deleteButton = document.createElement("button");
            deleteButton.textContent = "삭제";

            replyActions.appendChild(replyButton);
            replyActions.appendChild(editButton);
            replyActions.appendChild(deleteButton);

            replyItem.appendChild(replyHeader);
            replyItem.appendChild(replyContent);
            replyItem.appendChild(replyActions);

            parentElement.appendChild(replyItem);

            // 자식 댓글이 있으면 재귀적으로 추가
            reply.children.forEach(function(childReply) {
                appendReply(childReply, parentElement);
            });
        }

        window.onload = function() {
            var comments = [[${comments}]]; // Thymeleaf를 통해 서버에서 전달된 댓글 목록
            displayReplies(comments); // 페이지가 로드될 때 댓글 목록 조회
        }
    </script>
</head>
<body>
    <h3>Event Detail</h3>
    <table>
        <tr>
            <td colspan="2" th:text="${'['+ dto.boardStatus +']  '+ dto.boardTitle}"></td>
        </tr>
        <tr>
            <td th:text="'작성일: '+ ${dto.boardRegdate}"></td>
            <td th:text="'조회수: '+ ${dto.boardHits}"></td>
        </tr>
        <tr>
            <td colspan="2" th:text="${dto.boardContents}"></td>
        </tr>
        <tr>
            <td colspan="2"><a href="/user/event">목록</a></td>
        </tr>

    </table>
    <hr>
    <b>댓글</b>
    <div id="replyList"></div>

</body>
</html>