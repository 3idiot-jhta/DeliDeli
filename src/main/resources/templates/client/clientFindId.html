<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>아이디 찾기</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .error-message {
            color: red;
        }
        .success-message {
            color: green;
        }
    </style>
</head>
<body>
<h1>아이디 찾기</h1>
<form id="findIdForm">
    <label for="clientEID">사업자 등록번호:</label>
    <input type="text" id="clientEID" name="clientEID" required>
    <button type="button" id="checkEID">사업자 등록 번호 확인</button>
    <span id="clientEIDMessage" class="error-message"></span>
    <br>
    <label for="clientName">이름:</label>
    <input type="text" id="clientName" name="clientName" required>
    <br>
    <button type="submit" id="findIdButton" disabled>아이디 찾기</button>
    <li><a href="/client/login">사장 로그인</a></li>
    <li><a href="/client/register">사장 회원가입</a></li>
    <li><a href="/client/findPw">사장 비밀번호 찾기</a></li>
    <li><a href="/">뒤로가기</a></li>
</form>
<div id="message" class="success-message"></div>
<div id="errorMessage" class="error-message"></div>

<script>
    var isClientEIDValid = false; // 사업자 등록번호 유효성 변수

    $(document).ready(function() {
        $("#checkEID").click(function () {
            var clientEID = $("#clientEID").val();
            $("#clientEIDMessage").text("");  // 이전 메세지 제거
            $.ajax({
                url: "https://api.odcloud.kr/api/nts-businessman/v1/status",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify({
                    b_no: [clientEID]
                }),
                beforeSend: function (xhr) {
                    xhr.setRequestHeader("Authorization", "Infuser " + "XUXRe+FdFMkLRnaf0Lk4O3Y8FtaOkNX6UlFup4nZKTVo/RIHRFFTW56jFW7dGllnJq2XXGUYdSqnr+lBk/5nxw==");
                },
                success: function (response) {
                    if (response.data[0].b_stt_cd === "01") {
                        $("#clientEIDMessage").text("유효한 사업자 등록번호입니다.").removeClass('error-message').addClass('success-message');
                        isClientEIDValid = true;
                    } else {
                        $("#clientEIDMessage").text("유효하지 않은 사업자 등록번호입니다.").removeClass('success-message').addClass('error-message');
                        isClientEIDValid = false;
                    }
                    findIdFormValidity();
                },
                error: function () {
                    $("#clientEIDMessage").text("사업자 등록번호 확인에 실패했습니다.");
                    isClientEIDValid = false;
                    findIdFormValidity();
                }
            });
        });

        function findIdFormValidity() {
            if (isClientEIDValid) {
                $("#findIdButton").prop("disabled", false);
            } else {
                $("#findIdButton").prop("disabled", true);
            }
        }

        $("#findIdForm").submit(function(event) {
            event.preventDefault(); // 폼 기본 제출 방지

            var clientEID = $("#clientEID").val(); // 수정된 부분
            var clientName = $("#clientName").val();

            $("#message").text("");
            $("#errorMessage").text("");

            $.post("/client/findId", { clientEID: clientEID, clientName: clientName}, function(data) {
                if (data.success) {
                    $("#message").text("아이디가 이메일로 전송되었습니다.");
                } else {
                    $("#errorMessage").text("입력한 정보와 일치하는 사용자를 찾을 수 없습니다.");
                }
            }).fail(function() {
                $("#errorMessage").text("아이디 찾기에 실패했습니다.");
            });
        });
    });
</script>
</body>
</html>
