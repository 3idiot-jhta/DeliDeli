<!-- Start : 비로그인 -->
<div th:if="${user == null}">
    <!-- 로그인하지 않은 경우 -->
    <div id="guestAddressDisplay">
        <h2>대표주소지</h2>
        <p id="displayedGuestAddress" th:text="${selectedAddress != null ? selectedAddress : '현재 입력된 주소가 없습니다.'}"></p>
        <button onclick="showGuestAddressModal()">주소 입력</button>
    </div>

    <!-- 주소 입력 모달창 -->
    <div id="guestAddressModal" style="display: none;">
        <h2>주소 입력</h2>
        <form id="guestAddressForm">
            <label for="guestAddress">주소:</label>
            <input type="text" id="guestAddress" name="guestAddress" readonly required>
            <button type="button" onclick="execDaumPostcodeForGuest()">주소 찾기</button>
            <br>
            <label for="guestAddrDetail">상세 주소:</label>
            <input type="text" id="guestAddrDetail" name="guestAddrDetail">
            <br>
            <button type="button" onclick="applyGuestAddress()">적용</button>
            <button type="button" onclick="closeGuestAddressModal()">취소</button>
        </form>
    </div>
</div>
<!-- End : 비로그인 -->

<!-- Start : 로그인 -->
<!-- 로그인 상태 확인 -->
<div th:if="${user != null}">
    <!-- 로그인한 경우 -->
    <div th:each="address : ${addressList}" th:if="${address.defaultAddress}">
        <h2>대표주소지</h2>
        <p th:text="${address.address} + ' ' + ${address.addrDetail}"></p>
        <button onclick="toggleAddressList()">주소 변경</button>
    </div>
</div>
<br><br><br>

<!-- 주소 리스트 박스 -->
<div id="addressListBox" style="display: none;">
    <select id="addressSelect" onchange="selectAddress()">
        <option value="" disabled selected>주소를 선택하세요</option>
        <option th:each="address : ${addressList}"
                th:value="${address.userAddressKey}"
                th:text="${address.address} + ' ' + ${address.addrDetail}">
        </option>
    </select>
    <button onclick="showAddAddressModal()">주소 추가</button>
</div>
<br><br><br>

<!-- 주소 추가 모달창 -->
<div id="addAddressModal" style="display: none;">
    <h2>주소 추가</h2>
    <form id="addressForm">
        <label for="newAddress">주소:</label>
        <input type="text" id="newAddress" name="newAddress" readonly required>
        <button type="button" onclick="execDaumPostcode()">주소 찾기</button>
        <br>
        <label for="newAddrDetail">상세 주소:</label>
        <input type="text" id="newAddrDetail" name="newAddrDetail" required>
        <br>
        <label for="newZipcode">우편번호:</label>
        <input type="text" id="newZipcode" name="newZipcode" readonly required>
        <br>
        <button type="button" onclick="saveAddress()">저장</button>
        <button type="button" onclick="closeAddAddressModal()">취소</button>
    </form>
</div>
<!-- End : 로그인 -->

<!-- 가게 목록 검색창 -->
<div>
    <input type="text" id="storeSearchInput" placeholder="가게명을 입력하세요" />
    <button id="searchButton" onclick="searchStores()">검색</button>
</div>

<!-- 로그인시 카테고리 -->
<div th:if="${user != null}">
    <h3>카테고리 목록</h3>
    <ul>
        <li>
            <a href="/user/category/0">ALL</a>
        </li>
        <li th:each="category : ${categoryList}">
            <a th:href="@{'/user/category/' + ${category.categoryKey}}" th:text="${category.categoryName}"></a>
        </li>
    </ul>
</div>
<br><br><br>

<!-- 비로그인시 카테고리 -->
<div th:if="${user == null}">
    <h3>카테고리 목록</h3>
    <ul>
        <li>
            <a href="#" class="category-link" data-base-url="/user/category/0">ALL</a>
        </li>
        <li th:each="category : ${categoryList}">
            <a href="#"
               th:data-base-url="@{'/user/category/' + ${category.categoryKey}}"
               th:text="${category.categoryName}"
               class="category-link"></a>
        </li>
    </ul>
</div>
<br><br><br>

<!-- 가게 목록 -->
<div id="storeList">
    <h3>가게 목록</h3>
    <div th:each="store : ${storeList}">
        <!-- 전체 카드를 클릭할 수 있도록 a 태그로 감쌈 -->
        <a th:href="@{'/user/storeDetail/' + ${store.storeInfoKey}}" class="store-card" style="text-decoration: none; color: inherit;">
            <div th:if="${store != null}">
                <img th:if="${store.firstMenu != null}" th:src="@{${store.firstMenu.menuImg}}" alt="Menu Image">
            </div>
            <div class="store-info">
                <h2 th:text="${store.storeName}">가게 이름</h2>
                <p>
                    <!-- 별점 및 리뷰 수 -->
                    <span th:text="'⭐ ' + ${store.averageRating}">4.5</span>
                    <span th:text="'리뷰 ' + ${store.reviewCount}">리뷰 150</span>
                </p>
                <p th:if="${store.firstMenu != null}">메뉴: <span th:text="${store.firstMenu.menuName}">메뉴 이름</span></p>
                <!-- 배달비 및 배달 시간 정보 -->
                <p th:text="'배달비: ' + ${store.deliveryAmount1} + ' ~ ' + ${store.deliveryAmount3}"></p>
                <p th:text="'오픈시간 : ' + ${store.openTime}"></p>
                <p th:text="'마감시간 : ' + ${store.closeTime}"></p>
            </div>
        </a>
        <br><br><br>
    </div>
</div>

<!-- Start:Pagination -->
<th:block th:include="inc/user/pagination :: boardPagination (${type})"></th:block>
<!-- End:Pagination -->

<script src="/user/js/module/store.js"></script>

<!--
    // 주소 리스트 토글
function toggleAddressList() {
    var $addressListBox = $('#addressListBox');
    if ($addressListBox.is(':hidden')) {
        $addressListBox.show();
    } else {
        $addressListBox.hide();
    }
}

// 선택된 주소를 기본 주소로 설정
function selectAddress() {
    var addressKey = $('#addressSelect').val();
    if (addressKey) {
        setDefaultAddress(addressKey);
    }
}

// 주소 추가 모달창 표시
function showAddAddressModal() {
    $('#newAddress').val('');
    $('#newAddrDetail').val('');
    $('#newZipcode').val('');
    $('#addAddressModal').show();
}

// 주소 추가 모달창 닫기
function closeAddAddressModal() {
    $('#addAddressModal').hide();
}

// 다음 우편번호 API를 사용하여 주소 찾기
function execDaumPostcode() {
    new daum.Postcode({
        oncomplete: function(data) {
            var addr = '';
            var extraAddr = '';

            if (data.userSelectedType === 'R') { // 도로명 주소 선택 시
                addr = data.roadAddress;
            } else { // 지번 주소 선택 시
                addr = data.jibunAddress;
            }

            if (data.userSelectedType === 'R') {
                if (data.bname !== '' && /[동|로|가]$/g.test(data.bname)) {
                    extraAddr += data.bname;
                }
                if (data.buildingName !== '' && data.apartment === 'Y') {
                    extraAddr += (extraAddr !== '' ? ', ' + data.buildingName : data.buildingName);
                }
                if (extraAddr !== '') {
                    extraAddr = ' (' + extraAddr + ')';
                }
            }

            $('#newZipcode').val(data.zonecode);
            $('#newAddress').val(addr + extraAddr);
            $('#newAddrDetail').focus();
        }
    }).open();
}

// 추가된 주소 저장
function saveAddress() {
    var newAddress = $('#newAddress').val();
    var newAddrDetail = $('#newAddrDetail').val();
    var newZipcode = $('#newZipcode').val();

    $.post("/user/addAddress", {
        newAddress: newAddress,
        newAddrDetail: newAddrDetail,
        newZipcode: newZipcode
    }).done(function() {
        alert("새 주소가 추가되었습니다.");
        location.reload();
    }).fail(function() {
        alert("주소 추가에 실패했습니다.");
    });

    closeAddAddressModal();
}

// 기본 주소 설정
function setDefaultAddress(addressKey) {
    $.post("/user/setDefaultAddress", { addressKey: addressKey })
        .done(function() {
            alert("대표 주소가 변경되었습니다.");
            location.reload();
        })
        .fail(function() {
            alert("대표 주소 변경에 실패했습니다.");
        });
}

// 로그인하지 않은 사용자를 위한 임시 주소 입력 기능 추가
function showGuestAddressModal() {
    $('#guestAddress').val('');
    $('#guestAddrDetail').val('');
    $('#guestAddressModal').show();
}

// 임시 주소 입력 모달창 닫기
function closeGuestAddressModal() {
    $('#guestAddressModal').hide();
}

// 임시 주소 입력을 위한 다음 우편번호 API 사용
function execDaumPostcodeForGuest() {
    new daum.Postcode({
        oncomplete: function(data) {
            var addr = '';
            var extraAddr = '';

            if (data.userSelectedType === 'R') {
                addr = data.roadAddress;
            } else {
                addr = data.jibunAddress;
            }

            if (data.userSelectedType === 'R') {
                if (data.bname !== '' && /[동|로|가]$/g.test(data.bname)) {
                    extraAddr += data.bname;
                }
                if (data.buildingName !== '' && data.apartment === 'Y') {
                    extraAddr += (extraAddr !== '' ? ', ' + data.buildingName : data.buildingName);
                }
                if (extraAddr !== '') {
                    extraAddr = ' (' + extraAddr + ')';
                }
            }

            $('#guestAddress').val(addr + extraAddr);
            $('#guestAddrDetail').focus();
        }
    }).open();
}

// 카테고리 링크에 주소 파라미터를 추가하여 업데이트
function updateCategoryLinks() {
    var guestAddress = $('#guestAddress').val() || $('#displayedGuestAddress').text() || "";

    //console.log("Updating category links with address: " + guestAddress); // 디버깅용 로그 추가
    $('.category-link').each(function() {
        var $link = $(this);
        var baseUrl = $link.data('base-url');
        var updatedHref = baseUrl + "?address=" + encodeURIComponent(guestAddress);
        //console.log("Updated link: " + updatedHref); // 디버깅용 로그 추가
        $link.attr('href', updatedHref);
    });
}

// 페이지 로드 시 카테고리 링크를 업데이트하고 이벤트 위임 사용
$(document).ready(function() {
    updateCategoryLinks();

    // 이벤트 위임을 사용하여 동적으로 생성된 링크에도 이벤트 핸들러가 적용되도록 설정
    $(document).on('click', '.category-link', function(e) {
        e.preventDefault(); // 기본 동작 막기
       // console.log("Category link clicked: " + $(this).attr('href')); // 디버깅용 로그 추가
        updateCategoryLinks();  // 카테고리 클릭 시 링크 갱신
        window.location.href = $(this).attr('href'); // 주소를 포함한 링크로 이동
    });
});

// 임시 주소 적용
function applyGuestAddress() {
    var guestAddress = $('#guestAddress').val();
    var guestAddrDetail = $('#guestAddrDetail').val();
    var fullGuestAddress = guestAddress + " " + guestAddrDetail;

    if (guestAddress === "") {
        alert("주소를 입력하세요.");
        return;
    }

    // 입력된 주소를 화면에 표시
    $('#displayedGuestAddress').text(fullGuestAddress);
    $('#guestAddressDisplay').show(); // 대표주소지 섹션 표시
    $('#guestAddressModal').hide(); // 모달 숨기기

    // 서버에 주소를 보내고 해당 지역의 가게 목록을 가져옴
    $.ajax({
        url: "/user/filterStoresByAddress", // 가게 목록을 필터링하는 서버 API 호출
        type: "GET",
        data: { address: guestAddress }
    }).done(function(data) {
        $('#storeList').html($(data).find('#storeList').html());  // 가게 목록만 갱신
        // 페이지 전체 새로고침 방지
        history.pushState({}, null, '/user/category/0');
        // AJAX 완료 후 카테고리 링크 갱신
        updateCategoryLinks();
    }).fail(function() {
        alert("가게 목록을 불러오는데 실패했습니다.");
    });
}

// 가게명 검색 기능
function searchStores() {
    var query = $('#storeSearchInput').val().trim();
    var guestAddress = "";

    // 로그인 상태 확인
    if ($("div[th\\:if='${user != null}']").length) {
        // 로그인한 사용자의 주소 사용
        guestAddress = $("div[th\\:if='${user != null}'] p").text().trim();
    } else {
        // 비로그인 사용자의 임시 주소 사용
        guestAddress = $("#displayedGuestAddress").text().trim() || "";
    }

    if (query === "") {
        // 검색어가 비어 있을 경우 전체 목록을 요청
        $.ajax({
            url: "/user/category/0",
            type: "GET",
            data: {
                address: guestAddress,
                page: 1,
                pageSize: 8
            },
            success: function(data) {
                $('#storeList').html($(data).find('#storeList').html());  // 가게 목록만 갱신
                history.pushState({}, null, '/user/category/0?address=' + encodeURIComponent(guestAddress));
                location.reload(); // 페이지 새로고침
            },
            error: function(xhr, status, error) {
                alert("전체 목록을 불러오는데 실패했습니다.");
            }
        });
        return;
    }

    // 검색어가 있을 경우 검색 수행
    $.ajax({
        url: "/user/search",
        type: "GET",
        data: {
            query: query,
            address: guestAddress,
            page: 1,
            pageSize: 8
        },
        success: function(data) {
            $('#storeList').html($(data).find('#storeList').html());  // 가게 목록만 갱신
            history.pushState({}, null, '/user/search?query=' + encodeURIComponent(query) + '&address=' + encodeURIComponent(guestAddress));
            location.reload(); // 페이지 새로고침
        },
        error: function(xhr, status, error) {
            alert("검색 결과를 불러오는데 실패했습니다.");
        }
    });
}

// 검색 버튼 클릭 시 검색 수행
$('#searchButton').on("click", function() {
    searchStores();
});

-->